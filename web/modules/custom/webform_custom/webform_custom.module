<?php

/**
 * @file
 * Custom webform modifications.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_alter().
 *
 * Remove source entity from sidebar webform block to have consistent form IDs.
 * This prevents issues with Drupal States when the same form appears
 * on different pages.
 */
function webform_custom_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  // Only modify the ajanlatkeres webform
  if (strpos($form_id, 'webform_submission_ajanlatkeres') === 0) {
    // Attach JS to remove contextual-region class for HubSpot/Make integration
    $form['#attached']['library'][] = 'webform_custom/webform_custom';

    // Check if form ID contains node-specific pattern
    if (preg_match('/webform-submission-ajanlatkeres-node-\d+-add-form/', $form['#id'])) {
      // Standardize form ID
      $form['#id'] = 'webform-submission-ajanlatkeres-add-form';

      // Remove node-specific classes
      if (isset($form['#attributes']['class'])) {
        $form['#attributes']['class'] = array_filter($form['#attributes']['class'], function($class) {
          return strpos($class, '-node-') === false;
        });
        // Ensure generic class is present
        if (!in_array('webform-submission-ajanlatkeres-add-form', $form['#attributes']['class'])) {
          $form['#attributes']['class'][] = 'webform-submission-ajanlatkeres-add-form';
        }
      }

      // Update #states selectors to use the generic form class
      _webform_custom_update_states_selectors($form, '.webform-submission-ajanlatkeres-add-form');
    }
  }
}

/**
 * Implements hook_preprocess_form().
 *
 * Remove contextual-region class from ajanlatkeres webform to ensure
 * consistent CSS classes for HubSpot/Make integration.
 * This runs during theme preprocessing, after contextual module has added its class.
 */
function webform_custom_preprocess_form(array &$variables) {
  // Check if this is the ajanlatkeres webform
  if (isset($variables['element']['#id']) &&
      strpos($variables['element']['#id'], 'webform-submission-ajanlatkeres') === 0) {
    // Remove contextual-region class using Attribute object's removeClass method
    if (isset($variables['attributes']) && $variables['attributes'] instanceof \Drupal\Core\Template\Attribute) {
      $variables['attributes']->removeClass('contextual-region');
    }
  }
}

/**
 * Recursively update #states selectors in form elements.
 *
 * @param array $elements
 *   Form elements array (passed by reference).
 * @param string $new_form_class
 *   The new form class selector to use.
 */
function _webform_custom_update_states_selectors(array &$elements, $new_form_class) {
  foreach ($elements as $key => &$element) {
    if (!is_array($element)) {
      continue;
    }

    // Check for #states
    if (isset($element['#states'])) {
      foreach ($element['#states'] as $state => &$conditions) {
        if (!is_array($conditions)) {
          continue;
        }
        $new_conditions = [];
        foreach ($conditions as $selector => $condition) {
          // Replace node-specific selectors with generic one
          if (is_string($selector) && preg_match('/\.webform-submission-ajanlatkeres-node-\d+-add-form/', $selector)) {
            $new_selector = preg_replace(
              '/\.webform-submission-ajanlatkeres-node-\d+-add-form/',
              $new_form_class,
              $selector
            );
            $new_conditions[$new_selector] = $condition;
          }
          else {
            $new_conditions[$selector] = $condition;
          }
        }
        $conditions = $new_conditions;
      }
    }

    // Recurse into child elements (skip # prefixed keys that aren't arrays of elements)
    if ($key[0] !== '#' || $key === '#groups') {
      _webform_custom_update_states_selectors($element, $new_form_class);
    }
  }
}
