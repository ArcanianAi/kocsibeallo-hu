<?php

/**
 * @file
 * Custom webform modifications.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_alter().
 *
 * Remove source entity from sidebar webform block to have consistent form IDs.
 * This prevents issues with Drupal States when the same form appears
 * on different pages.
 *
 * Also removes contextual-region class to ensure consistent CSS classes
 * for HubSpot/Make integration.
 */
function webform_custom_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  // Only modify the ajanlatkeres webform
  if (strpos($form_id, 'webform_submission_ajanlatkeres') === 0) {
    // Add after_build callback to remove classes late in the build process
    $form['#after_build'][] = '_webform_custom_remove_classes';

    // Check if form ID contains node-specific pattern
    if (preg_match('/webform-submission-ajanlatkeres-node-\d+-add-form/', $form['#id'])) {
      // Standardize form ID
      $form['#id'] = 'webform-submission-ajanlatkeres-add-form';

      // Remove node-specific classes
      if (isset($form['#attributes']['class'])) {
        $form['#attributes']['class'] = array_filter($form['#attributes']['class'], function($class) {
          return strpos($class, '-node-') === false;
        });
        // Ensure generic class is present
        if (!in_array('webform-submission-ajanlatkeres-add-form', $form['#attributes']['class'])) {
          $form['#attributes']['class'][] = 'webform-submission-ajanlatkeres-add-form';
        }
      }

      // Update #states selectors to use the generic form class
      _webform_custom_update_states_selectors($form, '.webform-submission-ajanlatkeres-add-form');
    }
  }
}

/**
 * After build callback to remove unwanted CSS classes.
 *
 * This runs later in the form build process, after contextual module
 * has added its classes.
 */
function _webform_custom_remove_classes(array $form, FormStateInterface $form_state) {
  // Classes to remove for consistent tracking (HubSpot/Make integration)
  $classes_to_remove = [
    'contextual-region',
  ];

  if (isset($form['#attributes']['class'])) {
    $form['#attributes']['class'] = array_filter($form['#attributes']['class'], function($class) use ($classes_to_remove) {
      return !in_array($class, $classes_to_remove);
    });
    // Re-index the array
    $form['#attributes']['class'] = array_values($form['#attributes']['class']);
  }

  return $form;
}

/**
 * Recursively update #states selectors in form elements.
 *
 * @param array $elements
 *   Form elements array (passed by reference).
 * @param string $new_form_class
 *   The new form class selector to use.
 */
function _webform_custom_update_states_selectors(array &$elements, $new_form_class) {
  foreach ($elements as $key => &$element) {
    if (!is_array($element)) {
      continue;
    }

    // Check for #states
    if (isset($element['#states'])) {
      foreach ($element['#states'] as $state => &$conditions) {
        if (!is_array($conditions)) {
          continue;
        }
        $new_conditions = [];
        foreach ($conditions as $selector => $condition) {
          // Replace node-specific selectors with generic one
          if (is_string($selector) && preg_match('/\.webform-submission-ajanlatkeres-node-\d+-add-form/', $selector)) {
            $new_selector = preg_replace(
              '/\.webform-submission-ajanlatkeres-node-\d+-add-form/',
              $new_form_class,
              $selector
            );
            $new_conditions[$new_selector] = $condition;
          }
          else {
            $new_conditions[$selector] = $condition;
          }
        }
        $conditions = $new_conditions;
      }
    }

    // Recurse into child elements (skip # prefixed keys that aren't arrays of elements)
    if ($key[0] !== '#' || $key === '#groups') {
      _webform_custom_update_states_selectors($element, $new_form_class);
    }
  }
}
